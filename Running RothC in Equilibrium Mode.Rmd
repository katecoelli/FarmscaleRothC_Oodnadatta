---
title: "Running RothC in Equilibrium"
author: "Kate Coelli"
date: "28/07/2021"
output: html_document
---

This file outlines the process required to run RothC in Equilibrium mode in order to determine starting values of the carbon fractions in order to run RothC in real Time.

It is based on the process outlined in <https://www.bgc-jena.mpg.de/TEE/basics/2015/11/19/RothC/> which uses R package **SoilR**.

As a starting point, I will just be testing this code on one location.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Preparing the information required by the model

### Required libraries 
```{r libraries, message = FALSE, warning = FALSE}
library(SoilR)
library(tidyverse)
library(knitr)

```

### Required data
Before this code can be run, the required data must be obtained and tidied

```{r data tidying, eval = FALSE}
#Tidy this first
file.edit("soil_data_tidying.R")

#followed by this
file.edit("Equilibrium_monthly_data.R")
```

If these files have already been executed, load in the relevant outputs

```{r data, echo = FALSE}
soil_data<- read.csv("../Processed_Data/soil_data_0to30.csv")
LTA_climate<- read.csv("../Processed_Data/LTA_climate_data.csv")
kable(soil_data, caption = "Soil Data")
kable(LTA_climate, caption ="Long term average climate data")
```

### Other information required by SoilR
In this example we test a range of annual C inputs from 1 to 40 Mg/ha/yr
When I was to loop through multiple sites replace the 1s with i and include in a forloop 
```{r info}
soil.thick=30  #Soil thickness (organic layer topsoil), in cm
SOC=soil_data[1, "SOC"]       #Soil organic carbon in Mg/ha 
clay=soil_data[1, "Clay"]         #Percent clay
Cinputs=seq(1,20,1)   #Annual C inputs to soil in Mg/ha/yr 

```


Specify the number of years over which to run the simulation - we have selected 100 years here

```{r years}
years = seq(1/12, 500, by=1/12) #number of years, in monthly steps
```


### Calculate the effects of climate on decomposition using soilR functions
```{r fW and fT}
fT=fT.RothC(LTA_climate$LTA_temp) #Temperature effects per month
fW=fW.RothC(P=(LTA_climate$LTA_rain), E=(LTA_climate$LTA_evap), 
              S.Thick = soil.thick, pClay = clay, 
              pE = 1.0, bare = FALSE)$b #Moisture effects per month
xi.frame=data.frame(years,rep(fT*fW,length.out=length(years)))
kable(data.frame(Month = seq(1,12,1), Temperature_decomp=fT, Water_decomp=fW), caption = "monthly environmental effects on decomposition")

```
### Initial starting value for the resistant fraction

In this example we use measured ROC from Jon Grays maps of NSW

```{r reference, out.width = "70%", fig.align = "center", echo = FALSE}

include_graphics("rmd_images/Gray_et_al_2019.jpg")

```
As with the other items we will include this in a loop and replace 1 with i when we calculate at multiple sites

```{r}
IOM<- soil_data[1, "ROC"]

```


## Run the model
Here, we calculate the fractions on a monthly timestep and then take the average of the last 5 years of the simulation period.
This is assumed to be in an equilibrium state. 
This model is run through a number of different cinput options (specified in a previous code chunk).

```{r}
res = data.frame(c_input = NA, DPM=NA, RPM=NA, BIO=NA, HUM=NA, IOM=NA)    #nrow of matrix = 1 because res is an average value
results<- list()

for(i in 1:length(Cinputs)){
Model1<-RothCModel(t=years, C0=c(DPM=0, RPM=0, BIO=0, HUM=0, IOM=IOM),
                   In=Cinputs[i], clay=clay, xi=xi.frame) #Loads the model
tmp=getC(Model1) #calculates stocks for each pool per month
tmp=as.data.frame(tmp)
lst_5_yr=tmp[(nrow(tmp)-5*12):nrow(tmp),] #selects last 5 years of results
lst_5_yr_avge = colMeans(lst_5_yr) #calculates average of each pool
res[1] = Cinputs[i]
res[2:6] = lst_5_yr_avge
res$SOC = sum(res[2:6])
results[[i]]<-res
}

#average cinputs of last 5 years for each Cinput amount at a given site.
avge_by_cinputs<- do.call(rbind, results)

```


## Optimise the model
Here, the total SOC, determined by the sum of the fractions is compared to the SOC measurement at the site.
The summed fractions of the cinput which produces the smallest error will be used as the starting fractions to run the model in real time.

replace 1 with i once looping through sites
```{r}


for(i in 1:nrow(avge_by_cinputs)){
  observed<- soil_data[1,"SOC"]
  predicted<- avge_by_cinputs[i, "SOC"]
  error<- (observed-predicted)^2
  avge_by_cinputs[i,"error"]<- error
}

fractions<- avge_by_cinputs%>%
  dplyr::filter(error==min(error))



```


The final size of the pools after this 500 year spinup are displayed in the figure below

```{r, echo = FALSE}
kable(fractions, caption = "Fractions to initialise real time model")

```


The spinup results are plotted below

```{r, echo = FALSE}
matplot(years, tmp, type="l", lty=1, col=1:5,
        main = paste("equilibrium run of site:", soil_data[1,"ID"], "with plant inputs of ", Cinputs[7], "Mg/ha/year"),
        xlab="Time (years)", ylab="C stocks (Mg/ha)")
legend("topleft", c("DPM", "RPM", "BIO", "HUM", "IOM"),
        lty=1, col=1:5, bty="n")
```




